# 03. Data Modeling & Schema Strategy

## 1. Modeling Strategy (Dimensional Design)

We utilize a **Star Schema** variant optimized for BigQuery (Columnar Storage).

### Data Grain Definitions
*   **Transactional Grain**: Individual Trade consistency (e.g., `fact_trades` - one row per closed position).
*   **Periodic Grain**: Daily Aggregates (e.g., `agg_strategy_daily` - one row per strategy per day).
*   **Snapshot Grain**: Point-in-time state (e.g., `snapshot_accounts` - end-of-day equity).

### Dimensional Patterns
1.  **SCD Type 2 (Slowly Changing Dimensions)**:
    *   **Target**: `dim_strategies`.
    *   **Implementation**: Strategies are versioned. If a parameter changes (e.g., `stop_loss_pct` 1% -> 2%), a new row is created with a new `strategy_key` (surrogate) to preserve the history of the old strategy performance.
2.  **Degenerate Dimensions**:
    *   **Target**: `fact_trades` -> `signal_id`, `alpaca_order_id`.
    *   **Logic**: High-cardinality IDs are stored directly in the Fact table to avoid massive join tables.
3.  **Junk Dimensions**:
    *   **Target**: `rejection_reason` (Low cardinality flags).

---

## 2. Data Models (Abstraction Layers)

### A. Conceptual Model (The Business View)
*   **Entities**:
    *   **Strategy**: The "Rulebook" for trading.
    *   **Signal**: A specific "Suggestion" generated by a Strategy.
    *   **Trade**: An "Action" taken on a Signal.
    *   **Account**: The "Wallet" holding the value and risk.
*   **Relationships**:
    *   Strategy (1) -> (Many) Signals.
    *   Signal (1) -> (0 or 1) Trades.
    *   Signal (1) -> (0 or 1) Rejections.
    *   Account (1) -> (Many) Snapshots.

### B. Logical Model (The Attribute View)
*   **`Strategy`**: ID, Risk Params, Confluence Config, Active Status.
*   **`Signal`**: Symbol, Direction, Entry, Stops, Targets, Status (Waiting -> Hit).
*   **`Trade`**: Fill Price, Qty, Fees, PnL, Entry Time, Exit Time.
*   **`Account`**: Equity, Cash, Buying Power, Margin, Drawdown.

### C. Physical Model (The Database View)
*   **Hot Storage (Firestore)**: Document-oriented, optimized for *Write Speed* and *Real-time Access*.
    *   Collection: `dim_strategies` (Config).
    *   Collection: `live_signals` (State).
*   **Cold Storage (BigQuery)**: Column-oriented, optimized for *Aggregation* and *Analytics*.
    *   Table: `fact_trades` (Partitioned by `exit_date`).
    *   Table: `fact_rejected_signals` (Partitioned by `ds`).
    *   Table: `snapshot_accounts` (Partitioned by `ds`).
    *   Table: `summary_strategy_performance` (Partitioned by `ds`, Aggregate).

---

## 3. Schema Evolution Strategy
*   **Current State**: **Schema Guardian** (Strict Validation).
    *   We do *not* currently support automatic schema evolution (e.g., adding columns on the fly) to prevent data swamp issues.
    *   **Rule**: Code (Pydantic) is the source of truth. If DB diverges, the pipeline halts (Safety First).
*   **Future State (Phase 3)**:
    *   Controlled evolution for "Add Column" events compatible with BigQuery.
