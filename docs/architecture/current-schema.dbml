// Project: Crypto Sentinel Signals (Staff-Level Architecture)
// Storage: Firestore (Hot) & BigQuery (Cold)
// Partitioning: All BigQuery tables partitioned by 'ds' (YYYY-MM-DD)

// ==========================================
//  HOT STORAGE (Firestore) - Operational
// ==========================================

// GENERATED: dim_strategies
Table dim_strategies [headercolor: #ff9900] {
  strategy_id varchar [pk, note: 'Unique identifier for the strategy']
  active boolean [note: 'Whether the strategy is currently active']
  timeframe varchar [note: 'Trading timeframe (e.g., 1D, 4H, 1H)']
  asset_class enum [note: 'Asset class this strategy trades (CRYPTO or EQU...']
  assets list [note: 'List of asset symbols this strategy trades']
  risk_params json [note: 'Risk management parameters (stop_loss_pct, take...']
  confluence_config varchar [note: 'Configuration for confluence factors (e.g. {rsi...']
  pattern_overrides json [note: 'Overrides for specific patterns (e.g. {bullish_...']
  Note: 'Config table. Defines trading rules.'
}
// END_GENERATED

// GENERATED: live_signals
Table live_signals [headercolor: #e06666] {
  signal_id varchar [pk, note: 'Deterministic UUID5 hash of ds|strategy_id|symbol']
  ds date [note: 'Date stamp when the signal was generated']
  strategy_id varchar [ref: > dim_strategies.strategy_id, note: 'Strategy that generated this signal']
  symbol varchar [note: 'Asset symbol (e.g., BTC/USD, AAPL)']
  asset_class enum [note: 'Asset class (CRYPTO or EQUITY)']
  confluence_factors list [note: 'List of triggers/patterns (e.g., RSI_DIV, VCP_C...']
  entry_price float [note: 'Price at the time signal was triggered (candle ...']
  pattern_name varchar [note: 'Name of the pattern detected (e.g., bullish_eng...']
  status enum [note: 'Current lifecycle status of the signal']
  suggested_stop float [note: 'Suggested stop-loss price for this signal']
  valid_until timestamp [note: 'Logical expiration of the trading opportunity (...']
  delete_at timestamp [note: 'Physical expiration for database TTL cleanup (3...']
  invalidation_price float [note: 'Structure-based invalidation level (early exit)']
  take_profit_1 float [note: 'First profit target (Conservative, e.g., 2*ATR)']
  take_profit_2 float [note: 'Second profit target (Structural, e.g., 4*ATR)']
  take_profit_3 float [note: 'Current volatility-adjusted trailing stop (Chan...']
  exit_reason enum [note: 'Reason for trade exit (e.g., ExitReason.TP1)']
  discord_thread_id varchar [note: 'Discord thread ID for linking all lifecycle upd...']
  side enum [note: 'Trade direction (BUY for Long, SELL for Short)....']
  pattern_duration_days int [note: 'Duration in days from first pivot to signal (fo...']
  pattern_span_days int [note: 'Time span from first to last structural pivot i...']
  pattern_classification varchar [note: 'Pattern scale: STANDARD_PATTERN (5-90 days) or ...']
  structural_anchors list [note: 'List of structural pivots defining pattern geom...']
  rejection_reason varchar [note: 'Reason for rejection if status is REJECTED_BY_F...']
  rejection_metadata json [note: 'Forensic data for validation failures (e.g., ra...']
  confluence_snapshot json [note: 'Snapshot of indicator values at rejection: {rsi...']
  harmonic_metadata json [note: 'Harmonic pattern ratios for Fibonacci-based pat...']
  created_at timestamp [note: 'UTC timestamp when signal was created. Used for...']
  trade_type varchar [note: 'Trade classification: EXECUTED (broker order fi...']
  Note: 'Ephemeral opportunities.'
}
// END_GENERATED

// GENERATED: live_positions
Table live_positions [headercolor: #e06666] {
  position_id varchar [pk, note: 'Unique position identifier. Set to signal_id to...']
  ds date [note: 'Date when position was opened']
  account_id varchar [note: 'Alpaca account ID (e.g., paper for paper trading)']
  symbol varchar [note: 'Trading symbol (e.g., BTC/USD, NVDA). Required ...']
  asset_class enum [note: 'Asset class (CRYPTO or EQUITY). Defaults to CRY...']
  signal_id varchar [ref: - live_signals.signal_id, note: 'Reference to the Signal that triggered this pos...']
  alpaca_order_id varchar [note: 'Alpacas order ID returned after order submissio...']
  discord_thread_id varchar [note: 'Discord thread ID for trade notifications']
  status enum [note: 'Current status of the position']
  entry_fill_price float [note: 'Actual fill price at which the position was ent...']
  current_stop_loss float [note: 'Current stop-loss price (may be trailed)']
  qty float [note: 'Quantity/size of the position']
  side enum [note: 'Order side (buy or sell)']
  trailing_stop_final float [note: 'Final trailing stop value at exit (Chandelier E...']
  tp_order_id varchar [note: 'Alpaca order ID for the Take Profit leg. Popula...']
  sl_order_id varchar [note: 'Alpaca order ID for the Stop Loss leg. Populate...']
  target_entry_price float [note: 'Original signals entry price (target). Compare ...']
  filled_at timestamp [note: 'UTC timestamp when entry order was filled. From...']
  commission float [note: 'Total commission/fees reported by broker for th...']
  failed_reason varchar [note: 'Error message if order was rejected or canceled...']
  exit_fill_price float [note: 'Actual exit fill price from TP or SL order. Fro...']
  exit_time timestamp [note: 'UTC timestamp when exit order was filled. From ...']
  exit_reason enum [note: 'Reason for trade exit (e.g., TP1, STOP_LOSS, MA...']
  exit_order_id varchar [note: 'Alpaca order ID for the exit order. Used for re...']
  entry_order_id varchar [note: 'Entry order ID for CFEE attribution. Captured f...']
  exit_commission float [note: 'Commission from exit order(s). Sum of all scale...']
  total_fees_actual float [note: 'Actual fees from Alpaca CFEE activities (crypto...']
  awaiting_backfill boolean [note: 'Flag indicating exit fill price is pending back...']
  trade_type varchar [note: 'Trade classification: EXECUTED (broker order fi...']
  original_qty float [note: 'Original quantity before any scale-outs. Set on...']
  scaled_out_qty float [note: 'Total quantity scaled out (closed at TP1). For ...']
  scaled_out_price float [note: 'Average fill price of scale-out exit at TP1.']
  scaled_out_at timestamp [note: 'UTC timestamp of scale-out execution.']
  breakeven_applied boolean [note: 'Whether stop was moved to breakeven after TP1.']
  scaled_out_prices list [note: 'History of scale-outs: [{qty, price, timestamp}...']
  entry_slippage_pct float [note: 'Entry slippage: (entry_fill_price - target_entr...']
  exit_slippage_pct float [note: 'Exit slippage: (exit_fill_price - target_exit_p...']
  trade_duration_seconds int [note: 'Trade duration in seconds from filled_at to exi...']
  realized_pnl_usd float [note: 'Aggregate realized PnL in USD (includes scale-o...']
  realized_pnl_pct float [note: 'Aggregate realized PnL as percentage of entry. ...']
  created_at timestamp [note: 'UTC timestamp when position was created in Fire...']
  delete_at timestamp [note: 'Physical expiration for database TTL cleanup (9...']
  Note: 'Active Trades (Operational State).'
}
// END_GENERATED

Table rejected_signals [headercolor: #e06666] {
  ds string
  signal_id uuid [pk, ref: - live_signals.signal_id]
  strategy_id varchar [ref: > dim_strategies.strategy_id]
  rejection_reason varchar
  Note: 'Signals that failed quality gate filters.'
}

// ==========================================
//  COLD STORAGE (BigQuery) - Analytics
// ==========================================

// GENERATED: fact_trades
Table fact_trades [headercolor: #6d9eeb] {
  ds date [pk, note: 'Partition key - date of trade execution']
  trade_id varchar [pk, note: 'Unique identifier for this trade']
  account_id varchar [note: 'Alpaca account ID']
  strategy_id varchar [ref: > dim_strategies.strategy_id, note: 'Strategy that executed this trade']
  asset_class enum [note: 'Asset class traded (CRYPTO or EQUITY)']
  symbol varchar [note: 'Asset symbol traded']
  side enum [note: 'Order side (buy or sell)']
  qty float [note: 'Quantity traded']
  entry_price float [note: 'Entry fill price']
  exit_price float [note: 'Exit fill price']
  entry_time timestamp [note: 'UTC timestamp of entry fill']
  exit_time timestamp [note: 'UTC timestamp of exit fill']
  exit_reason enum [note: 'Reason for trade exit (e.g., TP1, COLOR_FLIP)']
  max_favorable_excursion float [note: 'Highest price reached during trade']
  pnl_pct float [note: 'Profit/Loss as percentage']
  pnl_usd float [note: 'Profit/Loss in USD']
  fees_usd float [note: 'Total fees paid in USD']
  slippage_pct float [note: 'Slippage as percentage of entry price']
  trade_duration int [note: 'Trade duration in seconds']
  discord_thread_id varchar [note: 'Discord thread ID for social context analytics']
  trailing_stop_final float [note: 'Final trailing stop value at exit (Chandelier E...']
  target_entry_price float [note: 'Original signals entry price (target). Compare ...']
  alpaca_order_id varchar [note: 'Alpaca brokers UUID for the entry order. Links ...']
  exit_order_id varchar [note: 'Alpaca brokers UUID for the exit order. Used fo...']
  fee_finalized boolean [note: 'Whether actual fees have been reconciled from A...']
  actual_fee_usd float [note: 'Actual fee from Alpaca CFEE (T+1 settlement). R...']
  fee_calculation_type varchar [note: 'Source of fee data: ESTIMATED (initial), ACTUAL...']
  fee_tier varchar [note: 'Alpaca volume tier at time of trade (e.g., Tier...']
  entry_order_id varchar [note: 'Entry order ID for CFEE attribution (from Issue...']
  fee_reconciled_at timestamp [note: 'Timestamp when fees were reconciled from CFEE. ...']
  exit_price_finalized boolean [note: 'Whether exit price has been finalized via patch...']
  exit_price_reconciled_at timestamp [note: 'Timestamp when exit price was finalized via pat...']
  scaled_out_prices list [note: 'History of scale-outs used for weighted average...']
  original_qty float [note: 'Original quantity before any scale-outs. Used f...']
  Note: 'Immutable Ledger of all CLOSED trades.'
}
// END_GENERATED

// GENERATED: snapshot_accounts
Table snapshot_accounts [headercolor: #6d9eeb] {
  ds date [pk, note: 'Partition key - snapshot date']
  account_id varchar [pk, note: 'Alpaca account ID']
  equity float [note: 'Total account equity in USD']
  cash float [note: 'Available cash in USD']
  calmar_ratio float [note: 'Calmar ratio (annualized return / max drawdown)']
  drawdown_pct float [note: 'Current drawdown percentage from peak']
  buying_power float [note: 'Current available buying power (Reg T)']
  regt_buying_power float [note: 'Reg T buying power']
  daytrading_buying_power float [note: 'Day trading buying power']
  crypto_buying_power float [note: 'Non-marginable buying power (Crypto BP)']
  initial_margin float [note: 'Initial margin requirement']
  maintenance_margin float [note: 'Maintenance margin requirement']
  last_equity float [note: 'Equity value at last close']
  long_market_value float [note: 'Total market value of long positions']
  short_market_value float [note: 'Total market value of short positions']
  currency varchar [note: 'Account currency (e.g., USD)']
  status varchar [note: 'Account status (e.g., ACTIVE)']
  pattern_day_trader boolean [note: 'Pattern Day Trader (PDT) flag']
  daytrade_count int [note: 'Number of day trades in last 5 days']
  account_blocked boolean [note: 'Whether account is blocked']
  trade_suspended_by_user boolean [note: 'Whether trading is suspended by user']
  trading_blocked boolean [note: 'Whether trading is blocked']
  transfers_blocked boolean [note: 'Whether transfers are blocked']
  multiplier float [note: 'Account leverage multiplier']
  sma float [note: 'SMA value (Special Memorandum Account)']
  Note: 'Daily Account state snapshots.'
}
// END_GENERATED

// GENERATED: fact_rejected_signals
Table fact_rejected_signals [headercolor: #6d9eeb] {
  doc_id varchar [note: 'Firestore document ID']
  ds date [pk]
  signal_id varchar [pk]
  symbol varchar
  asset_class varchar
  pattern_name varchar
  rejection_reason varchar
  trade_type varchar
  side varchar
  entry_price float
  suggested_stop float
  take_profit_1 float
  theoretical_exit_price float
  theoretical_exit_reason varchar
  theoretical_exit_time timestamp
  theoretical_pnl_usd float
  theoretical_pnl_pct float
  theoretical_fees_usd float
  created_at timestamp
  Note: 'Analytical archival of rejected opportunities.'
}
// END_GENERATED

// ==========================================
//  HOT TO COLD RELATIONSHIPS (Lineage)
// ==========================================

Ref: live_positions.position_id - fact_trades.trade_id [note: 'ETL: TradeArchival']
Ref: rejected_signals.signal_id - fact_rejected_signals.signal_id [note: 'ETL: RejectedSignalArchival']
