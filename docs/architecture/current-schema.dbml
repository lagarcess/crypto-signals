// Project: Crypto Sentinel Signals (Staff-Level Architecture)
// Storage: Firestore (Hot) & BigQuery (Cold)
// Partitioning: All BigQuery tables partitioned by 'ds' (YYYY-MM-DD)

// ==========================================
//  HOT STORAGE (Firestore) - Operational
// ==========================================

Table dim_strategies [headercolor: #ff9900] {
  strategy_id varchar [pk, note: 'Unique ID (e.g. btc_daily_hammer_v1)']
  active boolean [note: 'Kill switch']
  assets list [note: '["BTC/USD", "ETH/USD"]']
  risk_params json [note: '{"stop_loss_pct": 0.05}']
  confluence_config json [note: '{"rsi_period": 14}']
  Note: 'Config table. Defines trading rules.'
}

Table live_signals [headercolor: #e06666] {
  ds string [note: 'Partition Key']
  signal_id uuid [pk]
  strategy_id varchar [ref: > dim_strategies.strategy_id]
  symbol varchar
  side enum [note: 'buy, sell']
  status enum [note: 'WAITING, CONFIRMED, INVALIDATED, TP1_HIT']
  entry_price float
  take_profit_1 float
  take_profit_2 float
  take_profit_3 float
  suggested_stop float
  valid_until timestamp [note: 'Logical Expiration']
  delete_at timestamp [note: 'TTL: 30 Days']
  Note: 'Ephemeral opportunities.'
}

Table live_positions [headercolor: #e06666] {
  ds string [note: 'Partition Key']
  position_id uuid [pk, note: 'Set to signal_id']
  account_id varchar [note: 'Alpaca Account ID']
  signal_id uuid [ref: - live_signals.signal_id]
  symbol varchar
  side enum
  qty float
  entry_fill_price float
  current_stop_loss float
  status enum [note: 'OPEN, CLOSED']
  Note: 'Active Trades (Operational State).'
}

Table rejected_signals [headercolor: #e06666] {
  ds string
  signal_id uuid [pk, ref: - live_signals.signal_id]
  strategy_id varchar [ref: > dim_strategies.strategy_id]
  rejection_reason varchar
  Note: 'Signals that failed quality gate filters.'
}

// ==========================================
//  COLD STORAGE (BigQuery) - Analytics
// ==========================================

Table fact_trades [headercolor: #6d9eeb] {
  ds date [pk, note: 'Partition Key']
  trade_id uuid [pk, note: 'Links to position_id']
  account_id varchar
  strategy_id varchar [ref: > dim_strategies.strategy_id]
  symbol varchar
  side varchar
  qty float
  entry_price float
  exit_price float
  pnl_usd float
  pnl_pct float
  fees_usd float
  actual_fee_usd float
  fee_finalized boolean
  trade_duration int
  Note: 'Immutable Ledger of all CLOSED trades.'
}

Table snapshot_accounts [headercolor: #6d9eeb] {
  ds date [pk, note: 'Partition Key']
  account_id varchar [pk]
  equity float
  cash float
  buying_power float
  drawdown_pct float
  calmar_ratio float
  Note: 'Daily Account state snapshots.'
}

Table fact_rejected_signals [headercolor: #6d9eeb] {
  ds date [pk, note: 'Partition Key']
  signal_id uuid [pk]
  strategy_id varchar [ref: > dim_strategies.strategy_id]
  rejection_reason varchar
  theoretical_pnl_usd float
  Note: 'Analytical archival of rejected opportunities.'
}

// ==========================================
//  HOT TO COLD RELATIONSHIPS (Lineage)
// ==========================================

Ref: live_positions.position_id - fact_trades.trade_id [note: 'ETL: TradeArchival']
Ref: rejected_signals.signal_id - fact_rejected_signals.signal_id [note: 'ETL: RejectedSignalArchival']
