name: Deploy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read

concurrency:
  group: production
  cancel-in-progress: true

jobs:
  ci:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false || github.event_name == 'push'
    env:
      ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
      ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
      TEST_DISCORD_WEBHOOK: ${{ secrets.TEST_DISCORD_WEBHOOK }}
      DISCORD_SHADOW_WEBHOOK_URL: ${{ secrets.DISCORD_SHADOW_WEBHOOK_URL }}
      GOOGLE_CLOUD_PROJECT: ${{ vars.GOOGLE_CLOUD_PROJECT }}
      TEST_MODE: "true"
      ALPACA_PAPER_TRADING: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction --no-root

      - name: Lint & Security
        run: |
          poetry run ruff check .
          pip install pip-audit
          pip-audit --strict

      - name: Test
        run: |
          PYTHONPATH=src poetry run pytest tests/ \
          --cov=src/crypto_signals \
          --cov-report=term-missing \
          --cov-fail-under=63

  validate-deployment:
    needs: ci
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}

      - name: Dry-Run Configuration Validation
        run: |
          clean_var() { echo "$1" | xargs; }
          cat > dry_run_vars.yaml <<EOF
          TEST_MODE: "$(clean_var "${{ vars.TEST_MODE }}")"
          ALPACA_PAPER_TRADING: "$(clean_var "${{ vars.ALPACA_PAPER_TRADING }}")"
          GOOGLE_CLOUD_PROJECT: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          CRYPTO_SYMBOLS: "${{ vars.CRYPTO_SYMBOLS }}"
          DISCORD_USE_FORUMS: "${{ vars.DISCORD_USE_FORUMS }}"
          EOF
          gcloud run jobs describe crypto-signals-job --region=${{ vars.GCP_REGION }} --format="value(name)"

  cd:
    needs: [ci, validate-deployment]
    # Run on push to main when CI passes. validate-deployment is skipped on push (only runs on PRs)
    # so we accept both 'success' and 'skipped' for that job.
    if: |
      always() &&
      needs.ci.result == 'success' &&
      (needs.validate-deployment.result == 'success' || needs.validate-deployment.result == 'skipped') &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    env:
      IMAGE_BASE: ${{ secrets.GAR_REPOSITORY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.GOOGLE_CLOUD_PROJECT }}
          install_components: beta

      - name: Configure Docker Auth
        run: |
          GAR_HOST=$(echo "${IMAGE_BASE}" | cut -d/ -f1)
          gcloud auth configure-docker "${GAR_HOST}" --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_BASE }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Validate Container Build
        run: |
          IMAGE_SHA="${{ env.IMAGE_BASE }}:${{ github.sha }}"

          echo "üîç Testing container can import module..."
          docker run --rm \
            -e GOOGLE_CLOUD_PROJECT=${{ vars.GOOGLE_CLOUD_PROJECT }} \
            -e DISABLE_SECRET_MANAGER=true \
            "$IMAGE_SHA" \
            python -c "import crypto_signals.main; print('‚úÖ Module import successful')"

          echo "üí® Running containerized smoke test..."
          docker run --rm \
            -e DISABLE_SECRET_MANAGER=true \
            -e TEST_MODE=true \
            -e GOOGLE_CLOUD_PROJECT=${{ vars.GOOGLE_CLOUD_PROJECT }} \
            -e ALPACA_API_KEY=${{ secrets.ALPACA_API_KEY }} \
            -e ALPACA_SECRET_KEY=${{ secrets.ALPACA_SECRET_KEY }} \
            -e TEST_DISCORD_WEBHOOK=${{ secrets.TEST_DISCORD_WEBHOOK }} \
            -e LIVE_CRYPTO_DISCORD_WEBHOOK_URL=${{ secrets.LIVE_CRYPTO_DISCORD_WEBHOOK_URL }} \
            -e LIVE_STOCK_DISCORD_WEBHOOK_URL=${{ secrets.LIVE_STOCK_DISCORD_WEBHOOK_URL }} \
            -e DISCORD_SHADOW_WEBHOOK_URL=${{ secrets.DISCORD_SHADOW_WEBHOOK_URL }} \
            -e DISCORD_BOT_TOKEN=${{ secrets.DISCORD_BOT_TOKEN }} \
            -e CRYPTO_SYMBOLS="${{ vars.CRYPTO_SYMBOLS }}" \
            "$IMAGE_SHA" \
            python -m crypto_signals.main --smoke-test

          echo "‚úÖ Container validation complete"


      - name: Deploy to Cloud Run Job
        run: |
          clean_var() { echo "$1" | xargs; }
          cat > env_vars.yaml <<EOF
          TEST_MODE: "$(clean_var "${{ vars.TEST_MODE }}")"
          ALPACA_PAPER_TRADING: "$(clean_var "${{ vars.ALPACA_PAPER_TRADING }}")"
          ENABLE_EXECUTION: "$(clean_var "${{ vars.ENABLE_EXECUTION }}")"
          ENVIRONMENT: "$(clean_var "${{ vars.ENVIRONMENT }}")"
          ENABLE_EQUITIES: "$(clean_var "${{ vars.ENABLE_EQUITIES }}")"
          ENABLE_GCP_LOGGING: "$(clean_var "${{ vars.ENABLE_GCP_LOGGING }}")"
          DISABLE_SECRET_MANAGER: "$(clean_var "${{ vars.DISABLE_SECRET_MANAGER }}")"
          GOOGLE_CLOUD_PROJECT: "${{ vars.GOOGLE_CLOUD_PROJECT }}"
          DISCORD_CHANNEL_ID_CRYPTO: "${{ vars.DISCORD_CHANNEL_ID_CRYPTO }}"
          DISCORD_CHANNEL_ID_STOCK: "${{ vars.DISCORD_CHANNEL_ID_STOCK }}"
          CRYPTO_SYMBOLS: "${{ vars.CRYPTO_SYMBOLS }}"
          DISCORD_USE_FORUMS: "${{ vars.DISCORD_USE_FORUMS }}"
          EOF

          gcloud run jobs update crypto-signals-job \
            --image="${{ env.IMAGE_BASE }}:${{ github.sha }}" \
            --region=${{ vars.GCP_REGION }} \
            --env-vars-file=env_vars.yaml \
            --set-secrets="ALPACA_API_KEY=ALPACA_API_KEY:latest,ALPACA_SECRET_KEY=ALPACA_SECRET_KEY:latest,TEST_DISCORD_WEBHOOK=TEST_DISCORD_WEBHOOK:latest,LIVE_CRYPTO_DISCORD_WEBHOOK_URL=LIVE_CRYPTO_DISCORD_WEBHOOK_URL:latest,LIVE_STOCK_DISCORD_WEBHOOK_URL=LIVE_STOCK_DISCORD_WEBHOOK_URL:latest,DISCORD_SHADOW_WEBHOOK_URL=DISCORD_SHADOW_WEBHOOK_URL:latest,DISCORD_BOT_TOKEN=DISCORD_BOT_TOKEN:latest"

      - name: Deploy Monitoring Alert Policy
        run: |
          CHANNEL_NAME=$(gcloud beta monitoring channels list --filter='displayName="Discord Alerts"' --format='value(name)')
          if [ -z "$CHANNEL_NAME" ]; then
            CHANNEL_NAME=$(gcloud beta monitoring channels create --display-name="Discord Alerts" --type="webhook_tokenauth" --channel-labels="url=${{ secrets.DISCORD_DEPLOYS }}" --format='value(name)')
          fi

          cat > alert_policy.json <<EOF
          {
            "displayName": "Crypto Signals Runtime Error",
            "conditions": [{
              "displayName": "Log error detected",
              "conditionMatchedLog": {
                "filter": "resource.type=\"cloud_run_job\" AND resource.labels.job_name=\"crypto-signals-job\" AND severity>=ERROR"
              }
            }],
            "combiner": "OR",
            "enabled": true,
            "notificationChannels": ["$CHANNEL_NAME"],
            "alertStrategy": {
              "notificationRateLimit": {
                "period": "300s"
              }
            }
          }
          EOF

          POLICY_NAME=$(gcloud monitoring policies list --filter='displayName="Crypto Signals Runtime Error"' --format='value(name)')
          if [ -z "$POLICY_NAME" ]; then
            gcloud monitoring policies create --policy-from-file="alert_policy.json"
          else
            gcloud monitoring policies update "$POLICY_NAME" --policy-from-file="alert_policy.json"
          fi

      - name: Smoke Test (Execute Job)
        id: smoke_test
        if: "!contains(github.event.head_commit.message, '[skip-smoke]')"
        continue-on-error: true
        run: |
          gcloud run jobs execute crypto-signals-job \
            --region=${{ vars.GCP_REGION }} \
            --update-env-vars TEST_MODE=true,DISABLE_SECRET_MANAGER=true \
            --args="python,-m,crypto_signals.main,--smoke-test" \
            --wait

      - name: Auto-Rollback on Failure
        if: steps.smoke_test.outcome == 'failure'
        run: |
          gcloud run jobs update crypto-signals-job \
            --region=${{ vars.GCP_REGION }} \
            --image="${{ env.IMAGE_BASE }}:latest"
          exit 1

      - name: Promote Image to Latest (On Success)
        if: success() || (steps.smoke_test.outcome == 'skipped')
        run: |
          gcloud artifacts docker tags add "${{ env.IMAGE_BASE }}:${{ github.sha }}" "${{ env.IMAGE_BASE }}:latest" --quiet

  notify:
    runs-on: ubuntu-latest
    # Only notify when CI actually ran (skip drafts where everything is skipped)
    if: |
      always() &&
      needs.ci.result != 'skipped' &&
      (github.event.pull_request.draft == false || github.event_name == 'push')
    needs: [ci, validate-deployment, cd]
    steps:
      - name: Discord Notification
        env:
          WEBHOOK_URL: ${{ secrets.DISCORD_DEPLOYS }}
        run: |
          CI_STATUS="${{ needs.ci.result }}"
          VAL_STATUS="${{ needs.validate-deployment.result }}"
          CD_STATUS="${{ needs.cd.result }}"

          if [[ "$CI_STATUS" == "failure" || "$VAL_STATUS" == "failure" || "$CD_STATUS" == "failure" ]]; then
             COLOR="15158332" # Red
             EMOJI="üö®"
             FINAL_STATUS="FAILED"
          else
             COLOR="3066993" # Green
             EMOJI="‚úÖ"
             FINAL_STATUS="SUCCESS"
          fi

          status_emoji() {
            case "$1" in
              success) echo "üü¢ Passed" ;;
              failure) echo "üî¥ Failed" ;;
              skipped) echo "‚è≠Ô∏è Skipped" ;;
              cancelled) echo "‚ö™ Cancelled" ;;
              *) echo "‚ùì Unknown" ;;
            esac
          }

          curl -X POST "${WEBHOOK_URL}" -H "Content-Type: application/json" -d @- <<EOF
          {
            "content": "${EMOJI} Pipeline **${FINAL_STATUS}**",
            "embeds": [{
              "title": "Workflow Execution Summary",
              "color": ${COLOR},
              "fields": [
                {"name": "1. CI (Tests/Lint)", "value": "$(status_emoji $CI_STATUS)", "inline": true},
                {"name": "2. Validation", "value": "$(status_emoji $VAL_STATUS)", "inline": true},
                {"name": "3. Deployment", "value": "$(status_emoji $CD_STATUS)", "inline": true},
                {"name": "Author", "value": "${{ github.actor }}", "inline": true},
                {"name": "Commit", "value": "${{ github.sha }}", "inline": false}
              ]
            }]
          }
          EOF
