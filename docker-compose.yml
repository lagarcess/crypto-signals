version: '3.8'

services:
  crypto-signals:
    build:
      context: .
      dockerfile: Dockerfile
    image: crypto-signals:latest
    container_name: crypto-signals

    # Environment variables (for local testing)
    # In production, these should come from Google Secret Manager
    environment:
      # Cloud configuration
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/gcp-key.json

      # Alpaca credentials
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      - ALPACA_PAPER_TRADING=${ALPACA_PAPER_TRADING:-true}

      # Discord webhooks (Multi-destination routing)
      - TEST_DISCORD_WEBHOOK=${TEST_DISCORD_WEBHOOK}
      - TEST_MODE=${TEST_MODE:-true}
      # Production webhooks (uncomment when TEST_MODE=false)
      # - LIVE_CRYPTO_DISCORD_WEBHOOK_URL=${LIVE_CRYPTO_DISCORD_WEBHOOK_URL}
      # - LIVE_STOCK_DISCORD_WEBHOOK_URL=${LIVE_STOCK_DISCORD_WEBHOOK_URL}

      # Optional: Disable Secret Manager for local testing
      - DISABLE_SECRET_MANAGER=true

      # Optional: Rate limiting
      - RATE_LIMIT_DELAY=${RATE_LIMIT_DELAY:-0.5}

    # Mount secrets for local development
    # In production, use Google Secret Manager
    volumes:
      - ./secrets:/app/secrets:ro
      - ./logs:/app/logs

    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Restart policy
    restart: unless-stopped

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Optional: Health check service for monitoring
  healthcheck:
    build:
      context: .
      dockerfile: Dockerfile
    image: crypto-signals:latest
    container_name: crypto-signals-healthcheck
    command: ["python", "-m", "crypto_signals.scripts.health_check"]

    environment:
      - GOOGLE_CLOUD_PROJECT=${GOOGLE_CLOUD_PROJECT}
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/gcp-key.json
      - ALPACA_API_KEY=${ALPACA_API_KEY}
      - ALPACA_SECRET_KEY=${ALPACA_SECRET_KEY}
      - ALPACA_PAPER_TRADING=${ALPACA_PAPER_TRADING:-true}
      - TEST_DISCORD_WEBHOOK=${TEST_DISCORD_WEBHOOK}
      - TEST_MODE=${TEST_MODE:-true}
      - DISABLE_SECRET_MANAGER=true

    volumes:
      - ./secrets:/app/secrets:ro

    profiles:
      - healthcheck
